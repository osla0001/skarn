{%- doc -%}
  Displays product images in a carousel.
  Settings allow for a full slideshow, showing only the first image, or showing the second image when hovering.
  Note: When the product card itself is in a carousel layout, the card-gallery's carousel is disabled with JavaScript.

  @param [children] - Additional content rendered below the card gallery
  @param [section] - The section object the snippet is rendered in
  @param [block] - The block object the snippet is rendered in
{%- enddoc -%}

{% liquid
  assign product = closest.product
  assign block_settings = block.settings
  assign image_sizes = '(min-width: 750px) 50vw, 100vw'

  # Check if product has badges and determine position
  assign has_badges = false
  assign badge_position = null
  if product != blank
    if product.available == false or product.compare_at_price > product.price
      assign has_badges = true
      assign badge_position = settings.badge_position
    endif
  endif

  # if the card-gallery has a section.settings.product_card_size:
  # assume grid-template autofill(card-size, 1fr) and calculate the sizes attribute based on the minimum card size
  #
  # if section has section.settings.columns:
  # assume grid-template repeat(column-count, 1fr) and calculate the sizes attribute based on the number of columns
  if section.settings.product_card_size
    capture card_size
      render 'util-product-grid-card-size', section: section
    endcapture
    assign card_size = card_size | strip | replace: 'px', '' | plus: 0
    capture sizes_attribute
      render 'util-autofill-img-size-attr', card_size: card_size, card_gap: section.settings.columns_gap_horizontal
    endcapture
    assign image_sizes = sizes_attribute | strip
  elsif section.settings.columns and section.settings.layout_type != 'editorial'
    assign viewport_width = 100.0 | divided_by: section.settings.columns
    assign sizes_attribute = '(min-width: 750px) [viewport_width]vw, 100vw' | replace: '[viewport_width]', viewport_width
    assign image_sizes = sizes_attribute | strip
  endif

  assign ratio = '1'
  case block_settings.image_ratio
    when 'landscape'
      assign ratio = '16 / 9'
    when 'portrait'
      assign ratio = '4 / 5'
    when 'square'
      assign ratio = '1'
    when 'adapt'
      assign ratio = product.featured_media.preview_image.aspect_ratio | default: '1'
  endcase

  if block_settings.image_ratio == 'adapt' and block_settings.constrain_to_viewport
    if block_settings.constrain_to_viewport != ''
      assign constrain_to_viewport = true
      assign media_fit = block_settings.constrain_to_viewport
    endif
  endif
%}

<div
  ref="cardGallery"
  class="card-gallery card-gallery-{{ block.id }} spacing-style border-style{% if has_badges %} card-gallery--badge-{{ badge_position }}{% endif %}"  "
  data-product-id="{{ product.id }}"
  {%- comment -%} Hover image preview handled with CSS instead of pointer events to avoid JS swipe behavior {%- endcomment -%}
  {% if settings.transition_to_main_product %}
    data-view-transition-to-main-product
  {% endif %}
  data-image-ratio="{{ block_settings.image_ratio }}"
  {{ block.shopify_attributes }}
>
  {%- if product.media.size > 0 or product.images.size > 0 -%}
    {% assign images = product.media | where: 'media_type', 'image' %}
    {% if images.size == 0 %}
      {% assign images = product.images %}
    {% endif %}
    {% assign first_image = images[0] %}
    {% assign second_image = images[1] %}
    {% if images.size > 1 %}
      <div class="card-gallery__hover-fade-wrapper">
        {% if first_image %}
          <div class="card-gallery__fade-image card-gallery__fade-image--primary">
            {% render 'product-media', media: first_image, sizes: image_sizes, loading: 'eager', preview_image_only: true, class: 'product-media-container' %}
          </div>
        {% endif %}
        {% if second_image %}
          <div class="card-gallery__fade-image card-gallery__fade-image--secondary">
            {% render 'product-media', media: second_image, sizes: image_sizes, loading: 'lazy', preview_image_only: true, class: 'product-media-container' %}
          </div>
        {% endif %}
        <div class="card-gallery__indicators">
          <span class="card-gallery__indicator card-gallery__indicator--first"></span>
          <span class="card-gallery__indicator card-gallery__indicator--second"></span>
        </div>
      </div>
    {% elsif first_image %}
      <div class="card-gallery__fade-image card-gallery__fade-image--primary" style="position:relative;opacity:1;z-index:1;">
        {% render 'product-media', media: first_image, sizes: image_sizes, loading: 'eager', preview_image_only: true, class: 'product-media-container' %}
      </div>
    {% endif %}
  {% elsif product != blank and product.media.size == 0 %}
    <product-title class="product-card-gallery__title-placeholder">
      <a
        class="contents"
        ref="productTitleLink"
        href="{{ product.selected_or_first_available_variant.url}}"
        aria-hidden="true"
      >
        <span class="title-text">{{- product.title -}}</span>
      </a>
    </product-title>
  {% elsif product == blank %}
    {% liquid
      capture placeholder_image
        # Extract index from block ID (e.g., "product-card-3" -> "3")
        assign block_parts = block.id | split: '-'
        assign placeholder_index = block_parts.last | default: 0
        assign variant = placeholder_index | modulo: 3 | plus: 1
        assign placeholder_name = 'product-apparel-' | append: variant
        echo placeholder_name | placeholder_svg_tag: 'placeholder-image'
      endcapture
      capture placeholder_slide
        render 'slideshow-slide', index: 1, children: placeholder_image, class: 'product-media-container card-gallery__placeholder'
      endcapture
      render 'slideshow', ref: 'slideshow', slides: placeholder_slide, slide_count: 1, attributes: 'disabled="true"'
    %}
  {%- endif -%}
  {{ children }}
</div>

{% stylesheet %}
  .card-gallery {
    overflow: hidden;
    container-type: inline-size; /* Make card-gallery a container */
    container-name: card-gallery-container; /* Optional: name the container */
  }

  .card-gallery__placeholder svg {
    height: 100%;
    width: 100%;
  }

  .card-gallery svg {
    aspect-ratio: var(--gallery-aspect-ratio, var(--ratio));
  }

  .product-card-gallery__title-placeholder {
    padding: var(--padding-md);
    font-size: var(--font-size--2xl);
    line-height: var(--line-height--display-loose);
    word-break: break-word;
    color: var(--color-foreground);
    background-color: rgb(var(--color-foreground-rgb) / var(--opacity-5));
    aspect-ratio: var(--gallery-aspect-ratio);
    border-radius: var(--product-corner-radius);
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .product-card-gallery__title-placeholder a {
    color: var(--color-foreground);
  }

  @media screen and (min-width: 750px) {
    .product-grid[data-product-card-size='extra-large'] .product-card-gallery__title-placeholder {
      padding: var(--padding-3xl);
      font-size: var(--font-size--3xl);
    }

    .product-grid[data-product-card-size='large'] .product-card-gallery__title-placeholder {
      padding: var(--padding-2xl);
      font-size: var(--font-size--2xl);
    }

    .product-grid[data-product-card-size='medium'] .product-card-gallery__title-placeholder {
      padding: var(--padding-xl);
      font-size: var(--font-size--xl);
    }

    .product-grid[data-product-card-size='small'] .product-card-gallery__title-placeholder {
      padding: var(--padding-sm);
      font-size: var(--font-size--lg);
    }

    .product-grid[data-product-card-size='extra-large']
      .card-gallery.card-gallery--badge-top-right
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-3xl) + 50px);
    }

    .product-grid[data-product-card-size='large']
      .card-gallery.card-gallery--badge-top-right
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-2xl) + 50px);
    }

    .product-grid[data-product-card-size='medium']
      .card-gallery.card-gallery--badge-top-right
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-xl) + 50px);
    }

    .product-grid[data-product-card-size='small']
      .card-gallery.card-gallery--badge-top-right
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-sm) + 50px);
    }

    .product-grid[data-product-card-size='extra-large']
      .card-gallery.card-gallery--badge-top-left
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-3xl) + 40px);
    }

    .product-grid[data-product-card-size='large']
      .card-gallery.card-gallery--badge-top-left
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-2xl) + 40px);
    }

    .product-grid[data-product-card-size='medium']
      .card-gallery.card-gallery--badge-top-left
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-xl) + 40px);
    }

    .product-grid[data-product-card-size='small']
      .card-gallery.card-gallery--badge-top-left
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-sm) + 40px);
    }

    .product-grid[data-product-card-size='extra-large']
      .card-gallery.card-gallery--badge-bottom-left
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-3xl) + 40px);
    }

    .product-grid[data-product-card-size='large']
      .card-gallery.card-gallery--badge-bottom-left
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-2xl) + 40px);
    }

    .product-grid[data-product-card-size='medium']
      .card-gallery.card-gallery--badge-bottom-left
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-xl) + 40px);
    }

    .product-grid[data-product-card-size='small']
      .card-gallery.card-gallery--badge-bottom-left
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-sm) + 40px);
    }
  }

  @media screen and (max-width: 749px) {
    .product-card-gallery__title-placeholder {
      font-size: var(--font-size--xl);
      padding: var(--padding-md);
    }

    .product-grid[data-product-card-size]
      .card-gallery.card-gallery--badge-top-right
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-sm) + 50px);
    }

    .product-grid[data-product-card-size]
      .card-gallery.card-gallery--badge-top-left
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-sm) + 40px);
    }

    .product-grid[data-product-card-size]
      .card-gallery.card-gallery--badge-bottom-left
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-sm) + 40px);
    }
  }

  [product-grid-view='zoom-out'] .card-gallery .product-card-gallery__title-placeholder {
    /* stylelint-disable-next-line declaration-no-important */
    padding: var(--padding-xs) !important;
    font-size: var(--font-size--xs);
  }

  [product-grid-view='zoom-out'] .card-gallery .slideshow-control {
    min-width: auto;
  }
{% endstylesheet %}
