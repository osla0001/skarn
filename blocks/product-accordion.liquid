{% comment %}
Accordion block for product page
- Heading (h3) left, arrow SVG right
- Click toggles description
{% endcomment %}

<div class="product-accordion-block">
  <button class="product-accordion-toggle" type="button" aria-expanded="false">
    <span class="product-accordion-heading">{{ block.settings.heading }}</span>
    <span class="product-accordion-arrow" aria-hidden="true">
      <!-- SVG arrow, always black -->
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="color: #000;" xmlns="http://www.w3.org/2000/svg"><path d="M8 10L12 14L16 10" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </span>
  </button>
  <div class="product-accordion-content" hidden>
    <div class="product-accordion-description">{{ block.settings.description }}</div>
    {% if product.metafields.custom.kategori_billede %}
      <div class="product-accordion-image-wrapper" style="margin-top: 1rem;">
        <img src="{{ product.metafields.custom.kategori_billede | image_url: width: 600 }}" class="product-accordion-image" alt="Kategori billede">
      </div>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Accordion",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Overskrift"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Beskrivende tekst"
    },
    {
      "type": "image_picker",
      "id": "accordion_image",
      "label": "Accordion billede"
    }
  ],
  "presets": [
    { "name": "Accordion" }
  ]
}
{% endschema %}

{% javascript %}
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.product-accordion-toggle').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', !expanded);
      var content = btn.nextElementSibling;
      if (content && content.classList.contains('product-accordion-content')) {
        if (!expanded) {
          content.hidden = false;
          // Force reflow for transition
          void content.offsetWidth;
          content.classList.add('open');
        } else {
          content.classList.remove('open');
          // Wait for transition to finish before hiding
          content.addEventListener('transitionend', function handler(e) {
            if (e.propertyName === 'max-height') {
              content.hidden = true;
              content.removeEventListener('transitionend', handler);
            }
          });
        }
      }
    });
  });
  // Ensure closed accordions are hidden for accessibility
  document.querySelectorAll('.product-accordion-toggle').forEach(function(btn) {
    var content = btn.nextElementSibling;
    if (content && content.classList.contains('product-accordion-content')) {
      if (btn.getAttribute('aria-expanded') !== 'true') {
        content.hidden = true;
        content.classList.remove('open');
      } else {
        content.hidden = false;
        content.classList.add('open');
      }
    }
  });
});
{% endjavascript %}

<style>
.product-accordion-arrow svg {
  color: #000 !important;
  stroke: #000 !important;
}
</style>
